{% block content %}
<style>
:root {
  --phone-w: 375px;
  --phone-h: 812px;
  --radius: 44px;
}

/* Base page */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  background: #f2f3f7;
  font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
}

/* Stage centers phone perfectly */
.phone-stage {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: #f2f3f7;
}

/* Device shell */
.phone-shell {
  position: relative;
  width: calc(var(--phone-w) + 24px);
  height: calc(var(--phone-h) + 24px);
  box-sizing: border-box;
  padding: 12px;
  border-radius: calc(var(--radius) + 8px);
  background: linear-gradient(180deg, #0b0c10, #1b1c22);
  box-shadow:
    0 20px 60px rgba(0,0,0,0.35),
    0 6px 18px rgba(0,0,0,0.2) inset,
    0 0 0 2px #15161b inset;
}

/* Notch */
.phone-notch {
  position: absolute;
  top: 8px; left: 50%;
  transform: translateX(-50%);
  width: 210px; height: 28px;
  background: #0f1015;
  border-bottom-left-radius: 18px;
  border-bottom-right-radius: 18px;
}

/* Phone screen */
.phone-screen {
  position: relative;
  width: var(--phone-w);
  height: var(--phone-h);
  border-radius: var(--radius);
  background: #ffffff;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  box-shadow: 0 0 0 1px #e5e7eb inset;
}

.safe-top { height: 10px; }

/* Chat container */
.chat {
  min-height: calc(var(--phone-h) - 10px);
  display: flex;
  flex-direction: column;
  background: #fff;
}

/* Sticky header */
.chat-header {
  position: sticky; top: 0; z-index: 10;
  display: flex; flex-direction: column; gap: 6px;
  padding: 10px 12px;
  background: linear-gradient(180deg, #ffffff, #ffffffcc 85%, #ffffffcc);
  -webkit-backdrop-filter: saturate(180%) blur(12px);
  backdrop-filter: saturate(180%) blur(12px);
  border-bottom: 1px solid #E5E5EA;
}

/* Nav row: three columns — left back button, centered avatar+title, right invisible mirror */
.nav {
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* balance with mirror on right */
  align-items: center;
}

/* Back button */
.back-button {
  justify-self: start;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 6px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #007AFF;
  text-decoration: none;
}
.back-button::before { content: "‹"; font-size: 20px; line-height: 1; }
.back-button:hover { text-decoration: underline; }
.back-button:active { background: rgba(0,122,255,0.08); }

/* Center group (truly centered) */
.center-group {
  justify-self: center;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.nav-avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: #E5E5EA; color: #111;
  display: inline-flex; align-items: center; justify-content: center;
  font-weight: 600; font-size: 15px;
}
.nav-title {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.01em;
  color: #111;
}

/* Invisible mirror of back button to balance widths */
.back-mirror {
  justify-self: end;
  visibility: hidden;      /* occupies space, not visible */
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 6px;
  font-size: 16px;
  font-weight: 600;
}

/* Subline under nav */
.subline {
  font-size: 14px; color: #6b7280;
  display: flex; align-items: center; gap: 8px;
  justify-content: center;
}
.pill {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 12.5px; padding: 4px 10px; border-radius: 999px;
  background: #fff0f5; color: #d946ef; border: 1px solid #ffd6e8;
}

/* Messages */
.messages { padding: 14px 16px 26px; display: flex; flex-direction: column; }

.message {
  border-radius: 22px;
  padding: 12px 16px;
  margin: 4px 0;
  display: inline-block;
  word-break: break-word;
  white-space: pre-wrap;
  font-size: 16px;
  line-height: 1.35;
}

.yours { align-items: flex-start; display: flex; flex-direction: column; }
.yours .message {
  margin-right: 25%;
  background-color: #E5E5EA; color: #000; position: relative;
}
.yours .message.last:before {
  content: ""; position: absolute; bottom: 0; left: -6px;
  width: 16px; height: 16px; background: #E5E5EA; border-bottom-right-radius: 12px;
}
.yours .message.last:after {
  content: ""; position: absolute; bottom: 0; left: -10px;
  width: 10px; height: 16px; background: #fff; border-bottom-right-radius: 10px;
}

.mine { align-items: flex-end; display: flex; flex-direction: column; }
.mine .message {
  color: #fff; margin-left: 25%; background: #007AFF; position: relative;
}
.mine .message.last:before {
  content: ""; position: absolute; bottom: 0; right: -6px;
  width: 16px; height: 16px; background: #007AFF; border-bottom-left-radius: 12px;
}
.mine .message.last:after {
  content: ""; position: absolute; bottom: 0; right: -10px;
  width: 10px; height: 16px; background: #fff; border-bottom-left-radius: 10px;
}

.phone-screen, .phone-shell, .phone-stage { touch-action: pan-y; }

@media (max-height: 860px) { :root { --phone-h: 736px; } }
@media (max-width: 420px)  { :root { --phone-w: 340px; } }
</style>

{# ---------- Setup & parsing ---------- #}
{% set raw_conv = conversation|default('') %}
{% set other = other_username|default('Contact') %}
{% set liked_on_text = liked_on_text|default('') %}
{% set ns = namespace(msgs=[], pending=None) %}

{% for raw in raw_conv.split('\n') %}
  {% set line = raw.strip() %}
  {% if line %}
    {% set lp = namespace(handled=False) %}
    {% if line.startswith('You:') %}
      {% set ns.msgs = ns.msgs + [{'who':'mine','text': line[4:].strip()}] %}
      {% set ns.pending = None %}{% set lp.handled = True %}
    {% elif line.startswith(other ~ ':') %}
      {% set ns.msgs = ns.msgs + [{'who':'yours','text': line[other|length + 1:].strip()}] %}
      {% set ns.pending = None %}{% set lp.handled = True %}
    {% endif %}
    {% if not lp.handled %}
      {% if line in ['Y', 'You'] %}
        {% set ns.pending = 'mine' %}{% set lp.handled = True %}
      {% elif line in ['C', other] %}
        {% set ns.pending = 'yours' %}{% set lp.handled = True %}
      {% endif %}
    {% endif %}
    {% if not lp.handled %}
      {% set ns.msgs = ns.msgs + [{'who': (ns.pending or 'yours'), 'text': line}] %}
      {% set ns.pending = None %}
    {% endif %}
  {% endif %}
{% endfor %}

<div class="phone-stage">
  <div class="phone-shell">
    <div class="phone-notch" aria-hidden="true"></div>
    <div class="phone-screen" id="phoneScreen" role="region" aria-label="Chat window">
      <div class="safe-top"></div>

      <div class="chat">
        <div class="chat-header">
          <div class="nav">
            <!-- Left: back button -->
            <a href="/date_clones" class="back-button"
               onclick="if(this.getAttribute('href')==='#'){ history.back(); return false; }">
              Matches
            </a>

            <!-- Center: avatar + title (truly centered) -->
            <div class="center-group">
              <div class="nav-avatar">{{ other[:1]|upper }}</div>
              <div class="nav-title">Chat with {{ other }}</div>
            </div>

            <!-- Right: invisible mirror of the back button to balance widths -->
            <span class="back-mirror">Matches</span>
          </div>

          <div class="subline">
            <span class="pill">❤️ It’s a match</span>
            <span>
              Your clone liked {{ other }}{% if liked_on_text %} on {{ liked_on_text }}{% endif %}
            </span>
          </div>
        </div>

        <div class="messages">
          {% set N = ns.msgs|length %}
          {% for i in range(N) %}
            {% set m = ns.msgs[i] %}
            {% set prev_same = i>0 and ns.msgs[i-1].who == m.who %}
            {% set next_same = i+1 < N and ns.msgs[i+1].who == m.who %}

            {% if not prev_same %}<div class="{{ m.who }}">{% endif %}
              <div class="message {% if not next_same %}last{% endif %}">{{ m.text }}</div>
            {% if not next_same %}</div>{% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Scroll to bottom on load */
const screenEl = document.getElementById('phoneScreen');
if (screenEl) screenEl.scrollTop = screenEl.scrollHeight;

/* Prevent wheel scroll bleed at edges */
(function(){
  const el = document.getElementById('phoneScreen');
  if (!el) return;
  el.addEventListener('wheel', function(e){
    const delta = e.deltaY;
    const atTop = el.scrollTop === 0;
    const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
    if ((delta < 0 && atTop) || (delta > 0 && atBottom)) e.preventDefault();
  }, { passive: false });
})();
</script>
{% endblock %}
